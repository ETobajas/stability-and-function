---
title: "Title"
date: '2022-10-26'
output: 
  pdf_document :
    latex_engine : xelatex
header-includes:
 \usepackage{float}
 \floatplacement{figure}{H}
 \usepackage{caption}
 \renewcommand{\caption}{Figure}
 
bibliography: library.bib
csl: journalofecol.csl
 
---

# Abstract

1. Community stability can be influenced by species richness and asynchrony of species, however the relation with the stability of ecosystem functioning provided by this community is less explored, and specially for functions involving several trophic levels such as plant pollination. Understanding the mechanisms driving community stability and whether this stability should be related to the stability of ecosystem functions is important for predicting the resilience of communities to changes in biodiversity. 

2. Using a 5-year dataset across 13 Mediterranean shrub patches, we assessed the effect of the richness and asynchrony of pollinators as drivers of the stability of plant's visitation rate and plants reproductive success. [In addition, we analyzed whether the year together with richness and visitation rate affected the proportion of fruits and the number of seeds.](esto pensamos como ponerlo con los results finales) 

3. The stability of plant's visitation rate is affected by the asynchrony of pollinator species abundances but not by the pollinator richness. Likewise, we found a strong positive relationship between richness and asynchrony of pollinators. As for the stability of the plant reproductive success, the stability of fruits is not influenced by the stability of the visitation rate but a negative relation was observed between stability of seed and the stability of visitation rate. However, when years are analysed we found that in some years/[bad years](), the effect of pollinator richness and visitation rate on fruit proportion becomes important.

# Introduction

Global environmental changes and the biodiversity loss have highlighted the interest for better understanding the role of biodiversity in ecosystem function [@Hooper2005; @Lefcheck2015; @Oliver2015; @Hong2022]. We have experimental and observational evidence that biodiversity enhances ecosystem functioning [@Cardinale2006; @Cardinale2012; @Tilman2014], but the role of biodiversity for the stability of ecosystem functioning is less explored (but see @Griffin2009; @Grman2010), specially for functions involving several trophic levels such as plant pollination [@Ebeling2008; @Winfree2009a; @Garibaldi2011; @Lazaro2022]. Globally, it is estimated that at least 78% of wild plants and 75% of leading crops depend to some extent on pollination by animals [@Ollerton2011; @Kleijn2015]. Understanding the mechanisms driving pollinator community stability and how this relates to the stability of ecosystem functions and services delivered (i.e. pollination) is important for predicting changes in both community structure and ecosystem function.

Temporal stability is defined as the capacity of an ecosystem to dampen environmental perturbations over time while retaining ecological functions of interest [@Ives2007; @Pimm1984]. Among main driving of stability are the diversity and species asynchrony. A higher number of species might provide a wider range of responses to environmental changes, which would result in a higher stability [@McCann2000; @Tilman2006; @Hector2010; @Xu2021], although non-significant relationships between diversity and stability have also been observed [@Hooper2005; @VanderPlas2019]. The stability is also influenced by the degree of asynchrony between species. In this sense, higher levels of asynchrony in species fluctuation stabilize the community [@Ruijven2007; @Bluthgen2016; @Craven2018]. It has been also shown that stability can associate more strongly with the degree of asynchrony across species than with species richness [@Bluthgen2016; @Valencia2020]. While community temporal stability should be related to the stability of ecosystem functions and services, there is limited evidence linking both processes on multitrophic systems.

Since the reproductive success of most plant species highly depends on pollination by animal [@Ollerton2011], the stability of pollinator communities may increase the stability of plant reproductive success. A greater diversity of pollinators has been shown to increase the plant reproductive success as a result of complementary service provision arising from variation across of pollinator effectiveness, including space and time [@Hoehn2008; @Frund2010; @Albrecht2012; @Bluthgen2011; @Frund2013]. Pollinator species may exhibit different ranges of temporal activity [@Pisanty2016; @Rader2016] and consequently may provide pollination services at different times of the season. 
On the other hand, few studies link the visitation rate directly with plant reproductive. In some case, sites with more visitation show higher plant reproductive and in another they do not find relationship (Hegland and Totland 2012, Lundgren et al 2013; Kaiser‐Bunbury et al., 2017). Likewise, in more visited sites, it has been observed lower pollen limitation of fruit set and seed production [(Cosacov et al., 2008; Gómez et al., 2010; Williams & Winfree, 2013)](). The occurrence and magnitude of pollen limitation can varies among years for individual populations (Burd 1994, Ashman et al. 2004), primarily because of variation in pollinator service (Aizen and Harder 2007).   


[gap](I think something about temporal variation and pollen limitation)


In the current study, we use a 5-year dataset in Mediterranean woodland patches to study the role of richness and asynchrony of pollinator species as drivers of stability of visitation rate. We also evaluate whether the stability of plant reproductive success, employed the stability of fruit proportion and stability of seed numbers, is affected by the stability of pollinator communities. In addition, we analyzed whether the effect of the pollinator richness and visitation rate on the reproductive success of the plants varies over time. We expect that the stability of visitation rate will increase with higher richness and asynchrony of pollinators. In addition, a greater stability of plant reproductive success is expected with higher stability of visitation rate.


# Material and method

Our study was conducted in the southwest of the Iberian Peninsula (Huelva and Sevilla - Spain). We selected 13 sites in Mediterranean shrub ecosystems that ranged from sites with little to no disturbances to more modified ones with crops and urban areas nearby. These sites had similarity in plant community composition and some of most abundance plant species provide nectar and pollen that attract flower visitors. Each site was surveyed at least 7 times per year during the flowering season from 2015 to 2019 (from March to June). Within each site, we selected 3-4 individuals belonging to 3-9 plant species (mean  ± standard error: 5.92  ± 0.54 plant species per site). All the floral visitors (from now on referred to as pollinators) that contacted with their flowers were registered by performing focal observations to the selected individuals during five minutes in 2015-2016 and three minutes from 2017 to 2019. Only pollinators that could not be identified in the field were captured, stored, and identified to species level in the laboratory. For each plant individual, we counted the total number of flowers and at the end of the season, we recorded the number of fruit and the seeds per fruit. All plants analyzed are at least partially pollinator dependent.
Due to the focal time observation was different over years, for each plant individual, the effort of sampling was standardized in number of visits per minute dividing the total visits observed by total observation time (time observation multiplied by number of survey per year).
For each site and year, we calculated the visitation rate of pollinators as the number of visits divided by the number of flowers, pollinator richness, the fruit set as the proportion of fruit, and the seed set as number of seed per fruit for each plant individual sampled per site.

## Stability

For the study of stability, we used 5 plant species (*Cistus crispus*, *Cistus ladanifer*, *Cistus salviifolius*, *Halimium halimifolium*, and *Lavandula pedunculata*) because of they were recorded in at least 5 sites and a minimum of two years per site. The stability of visitation rate was quantified as the inverse of the coefficient of variation (mean/SD) for each plant species in each plot following Tilman, 1999. To examine the role of richness and synchrony of pollinator species as drivers of stability of visitation rate, we calculate the richness as the total number of pollinator species that visit each plant species in each plot. [The synchrony index for each plant species in the plot was calculated following Loreau and de Mazancourt (2008), as:](al final he puesto que utilizamos este solo porque al corregir el esfuerzo de muestreo este y el de Gross ya no estan correlacionados. He analizado el de Gross y no hay relacion con la estabilidad de las visitas. Muchos trabajos que solo utilizan un indice no dicen que hayan probado otros como es el trabajo de Lazaro, y he visto que muchos ponen la ecuacion, si no te parece bien asi vuelvo a poner los tres y explico lo de la correlacion) 


$$
\begingroup\Large
\phi =\frac{\sigma_{x_T}^2}{(\sum\sigma_{x_T})^2}
\endgroup
$$
where ${\sigma_{x_T}^2}$ represents the temporal variance of the community times series and ${(\sum\sigma_{x_T})^2}$ represents the sum of the temporal standard deviation of the time series across all species. This synchrony measurement varies from zero, when fluctuations are perfectly asynchronous, to one, when fluctuations are perfectly synchronous. Finally, we express asynchrony as $1-\phi$.
We also calculated the stability of fruit proportion and of the seed number for each plant species in each plot.

## Statistical analysis

Linear mixed models were used to evaluate the relationships between 1) stability of visitation rate and asynchrony of pollinator, 2) stability of visitation rate and pollinator richness, and 3) asynchrony and pollinator richness. In all case, site and plant species were included as random factor.
For a deeper understanding, we also analyzed the response for each plant species separately.

To study whether the stability of the visitation rate influenced in the stability of the plant reproductive success, we run linear mixed models using as response variables the stability of fruit proportion or stability of seed number and as explanatory variable the visitation rate stability. Site and plant species were included as factor random.

To detect whether the effect of pollinator richness and visitation rate is different across the years, we use all plant species sampled. We analyzed the interaction effect richness and year, and visitation rate and year on fruit proportion using binomial generalized linear mixed models, and on the number of seeds employing linear mixed model. The number of seeds per fruit was centered and scaled per plant species to allow meaningful comparisons across species. For all models, we included plant species identity nested within site and site as random effects because of multiple individuals of the same plant species are measured at each site.

All the analyses of this study were conducted in R software (v. 4.0.2; R Core Team, 2022) and the lme4 (Bates et al., 2015) and ggplot2 (Wickham, 2016) packages. DHARMa package was employed for checking all models (Harting 2017) 


# Results

## Stability of visitation rate and its drives: richness and synchrony 

Stability of visitation rate ranged from 0.64 to 9.24 (mean ± SE: 1.928 ± 0.232), whereas pollinator richness ranged from 2 to 20 (8.128 ± 0.686) and the pollinator asynchrony varied from 0 to 0.998 (0.754 ± 0.032).
Our results showed a positive tendency between stability of visitation rate and asynchrony with greater visitation rate stability when pollinator asynchrony increases (Estimate ± standard error: 2.903 ± 1.134) (Fig 1A),
whereas stability of visitation rate was not influenced by the pollinator richness (-0.001 ± 0.063) (Fig 1B). We also found a positively strong relationship between asynchrony and pollinator richness (0.020 ± 0.005) (Fig 1C). 
We observed one data with high leverage of visitation rate stability (*C.crispus*) however when we removed this point the tendencies are the same.

When we analysed the plant species separately, we observed positive tendency in asynchrony for *C. crispus*, *H. halimifoliun* and *L. pedunculata* and milder tendency in *C. salviifolious* being the slightly negative tendency in *C.ladanifer*. In the case of richness, *C. crispus*, *C. ladanifer* and *C. salviifolius* showed a negative tendency wile *H. halimifolium* and *L. pedunculata* was positive (Supplementary material-Fig 1).


```{r, echo=FALSE, warning=FALSE,message=FALSE,fig.height = 8,fig.width=20, out.width="100%",fig.align='center', fig.cap =" 1.Relationships between stability of visitation rate (calculated as the inverse of the coefficient of variation) and asynchorny of pollinators (Loreau and de Mazancourt’s index) (A), stability of visitation rate and pollinator richness (B), and asynchorny of pollinators and richness (C).Dots represent the different plant species incluided in the analysis.Significant models are representing with solid line."}

library(tidyverse)
library(lme4)
library(effects)
library(patchwork)


# staility of visitation rate and richness and asynchrony
# plant species present at least in five sites
# C.crispu, C. ladanifer, C. salviifolius, H.halimifolium and L. pedunculata

# stability data 
data_plant<- read.csv("../Data/Stability.csv")
data_plant<-data_plant[,-1]


# eliminar plant species 
sp_out2=data_plant %>%
  group_by(Plant_gen_sp) %>%
  summarise(Unique_Id = n_distinct(Site_ID)) %>%
  filter(Unique_Id <= 4) %>%
  select(Plant_gen_sp) %>% pull(Plant_gen_sp)

#Data with species in at least 5 sites
data_plant = data_plant %>% filter(!Plant_gen_sp %in% sp_out2)


data_plant=data_plant %>%
  filter(!Plant_gen_sp=="Salvia rosmarinus") %>%
  filter(!Plant_gen_sp=="Halimium calycinum")%>%
  filter(!Plant_gen_sp=="Lavandula stoechas")



## Replace Inf and -Inf with NA
data_plant[is.na(data_plant) | data_plant == "Inf"] <- NA 
data_plant[is.na(data_plant) | data_plant == "-Inf"] <- NA 



# We can express asynchrony as 1 - φ, 
#where φ is Loreau and de Mazancourt’s (2008)
data_plant$asyn_LM= 1-data_plant$syncLM


#model 
mod1_sta= lmer (cv_1_visitation ~ asyn_LM + (1|Site_ID) + (1|Plant_gen_sp), data = data_plant)



#getting effects for asynchrony
effe_mod_sta <-data.frame( effect("asyn_LM", mod1_sta, se = TRUE))


#plot model of asynchrony
p1=ggplot(effe_mod_sta, aes(asyn_LM, fit)) + geom_line(size=1)+
  geom_ribbon(aes(ymin = lower, ymax = upper),alpha=0.2)+
  scale_y_continuous(limits = c(-2.5, 9.5))+labs(color='Plant species')+
  geom_point(data = data_plant, aes(x =  asyn_LM, y = cv_1_visitation, color=Plant_gen_sp), alpha=0.7,size=6)+
  scale_colour_brewer(palette = "Set1")+
   theme_bw ()+
  labs(x = "Asynchrony of pollinator",y="Stability of visitation rate")+
  guides(colour=guide_legend(nrow=2,byrow=TRUE))+ theme(legend.text = element_text(face="italic"))



#model richness
mod1.2_sta= lmer (cv_1_visitation ~ S_total + (1|Site_ID) + (1|Plant_gen_sp), data = data_plant)


#getting effects for richness
effe2_mod_sta <-data.frame( effect("S_total", mod1.2_sta, se = TRUE))



#plot model of richness
p2=ggplot(effe2_mod_sta, aes(S_total, fit)) + geom_line(size=1,linetype = "dashed")+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha=0.1)+
  scale_y_continuous(limits = c(-2.5, 9.5))+  labs(color='Plant species')+
  geom_point(data = data_plant, aes(x =  S_total, y = cv_1_visitation, color=Plant_gen_sp), alpha=0.7,size=6)+
  scale_colour_brewer(palette = "Set1")+
  theme_bw ()+
  labs(x = "Richness of pollinator",y="Stability of visitation rate") +
  guides(colour=guide_legend(nrow=2,byrow=TRUE))+ theme(legend.text = element_text(face="italic"))
  

# relationship between richness and asynchrony
mod_rich_asyn= lmer (asyn_LM ~ S_total +  (1|Site_ID) + (1|Plant_gen_sp), weights = asyn_LM, data = data_plant)

#getting effects for richness
effe_rich_mod_sta <-data.frame( effect("S_total", mod_rich_asyn, se = TRUE))
#plot model 
p1.2=ggplot(effe_rich_mod_sta, aes(S_total, fit)) + geom_line(size=1)+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha=0.2)+
  labs(color='Plant species')+
  geom_point(data = data_plant, aes(x =  S_total, y = asyn_LM, color=Plant_gen_sp), alpha=0.7,size=6)+
  scale_colour_brewer(palette = "Set1")+
  theme_bw ()+
  labs(x = "Richness of pollinator",y="Asynchrony of pollinator")+
  guides(colour=guide_legend(nrow=2,byrow=TRUE))+ theme(legend.text = element_text(face="italic"))
  



#join plots
p_cv_visit=p1+p2+ p1.2+
  plot_annotation(tag_levels = "A")& 
  theme(plot.tag.position = c(0, 1),
        plot.tag = element_text(hjust = -0.1,vjust=0.5, size=25))& 
  theme(legend.position = "bottom",legend.background = element_blank(),legend.box.background = element_rect(colour = "black"))&theme(text = element_text(size=25))
p_cv_visit+ plot_layout(guides = "collect")

```


## Stability of visitation rate and stability of the plant reproductive success

Stability of fruit proportion varied from 2.62 to 120.66 (mean ± SE: 19.806 ± 3.615), whereas the stability of seed number ranged 1.28 to 55.86 (7.018 ± 1.441).
When we analyzed whether the stability of the visitation rate affected the stability of the plant reproductive success, we did not find a relationship between this and the stability of the fruit proportion (Estimate: -1.547; std. error: 2.611) (Fig 2A). However, the stability of seed number showed negative tendency with the stability of visitation rate (Estimate: -1.887; std. error: 0.959) (Fig 2B).

```{r,echo=FALSE, warning=FALSE,message=FALSE, fig.height = 10,fig.width=20,out.width="80%",fig.align='center', fig.cap = " 2. Relationship between stability of plant reproductive succes: fruit propotion (A) and seed number (B) and the stability of visitation rate. Dots represent the different plant species incluided in the analysis.Significant models are representing with solid line."}

#model fruit stability ~ visitation rate stability
mod2_sta= lmer(cv_1_fruit ~ cv_1_visitation + (1|Plant_gen_sp)+(1|Site_ID), data = data_plant)

#getting effects 
effe3_mod_sta <-data.frame( effect("cv_1_visitation", mod2_sta, se = TRUE))


#plot model 
p_mod2=ggplot(effe3_mod_sta, aes(cv_1_visitation, fit)) + geom_line(size=1,linetype = "dashed")+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha=0.1)+
  geom_point(data = data_plant, aes(x =  cv_1_visitation, y = cv_1_fruit, color=Plant_gen_sp),alpha=0.7, size=7)+
  labs(color='Plant species')+
  scale_colour_brewer(palette = "Set1")+
  labs(y = "Stability of fruit proportion",x="Stability of visitation rate")+
  theme_bw ()+
  guides(colour=guide_legend(nrow=2,byrow=TRUE))+ theme(legend.text = element_text(face="italic"))





# model seed stability ~ visitation rate stability
mod3_sta= lmer(cv_1_seed ~ cv_1_visitation + (1|Plant_gen_sp)+(1|Site_ID), data = data_plant)


#getting effects 
effe4_mod_sta <-data.frame( effect("cv_1_visitation", mod3_sta, se = TRUE))


#plot model 
p_mod3=ggplot(effe4_mod_sta, aes(cv_1_visitation, fit)) + geom_line(size=1)+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha=0.2)+
  labs(color='Plant species')+
  geom_point(data = data_plant, aes(x =  cv_1_visitation, y = cv_1_seed, color=Plant_gen_sp), alpha=0.7,size=7)+
  scale_colour_brewer(palette = "Set1")+
  labs(y = "Stability of seed number",x="Stability of visitation rate")+
  theme_bw ()+
  guides(colour=guide_legend(nrow=2,byrow=TRUE))+ theme(legend.text = element_text(face="italic"))



#join plots
p_plant=p_mod2+p_mod3+ 
  plot_annotation(tag_levels = "A")& 
  theme(plot.tag.position = c(0, 1),
        plot.tag = element_text(hjust = -0.8, vjust = 0.5,size=30))& 
  theme(legend.position = "bottom",legend.background = element_blank(),legend.box.background = element_rect(colour = "black"))&theme(text = element_text(size=30))
p_plant+ plot_layout(guides = "collect")

```


## Effect of pollinators across years on the plant reproductive success

When we analysed whether the effect of pollinator richness and visitation rate is different across the years, we found that both variables showed a significant interaction effect with the year on fruit proportion [(richness:year p = <0.0001; visitation rate:year p = <0.0001)](tengo que poner Anova tipo III??? y algun dato mas como df??). Although we observed a saturation of the fruit proportion, in year like 2017 is showed that a greater richness and visitation rate increased the fruit proportion. We also observed a positive tendency between richness and fruit proportion in 2019. However in 2018, the relationship between richness and fruit proportion was negative (Fig 3). 

For the seed number, we not found the interaction effect to pollinator richness (p = 0.628), however we found a marginal significant interaction between visitation rate and year (p = 0.058). We observed that a higher the visitation rate increased the seed number in 2019 (Supplementary material-Fig 2).


```{r,echo=FALSE, warning=FALSE,message=FALSE,fig.height =13,fig.width=30,out.width="100%", fig.align='center',fig.cap=" 3. Interaction effect between richness and year (top row), and visitation rate and year (bottom row) on fruit proportion. For the visualization purpose, we omit in the visitation rate (x-axis) the values outside of the 95\\%."}

Pollinator_Plant<- read.csv("../Data/Pollinator_Plant.csv") #400 observaciones
Pollinator_Plant<-Pollinator_Plant[,-1]
Pollinator_Plant$Year= as.factor(Pollinator_Plant$Year)
Pollinator_Plant$Site_ID= as.factor(Pollinator_Plant$Site_ID)
Pollinator_Plant$Plant_gen_sp= as.factor(Pollinator_Plant$Plant_gen_sp)


# species out
#plant species that for each year occur only at one site
spp_out <- Pollinator_Plant %>%
  group_by(Plant_gen_sp, Year) %>%
  summarise(Unique_Id = n_distinct(Site_ID)) %>%
  filter(Unique_Id == 1) %>%
  select(Plant_gen_sp, Year)


Pollinator_Plant= anti_join(Pollinator_Plant, spp_out)



# model 1
mod1_to= glmer(cbind(fruit_formado, Fruit_No) ~ S_total * Year + (1|Site_ID/Plant_gen_sp),family=binomial,data=Pollinator_Plant)

#getting effects for the two variables
ee_mod1 <- as.data.frame(Effect(c("S_total","Year"),mod = mod1_to))

p1=ggplot(ee_mod1, aes(S_total,fit))+
  geom_line(size=0.8)+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .2)+
  geom_point(data= Pollinator_Plant, aes(x = S_total , y = fruit_proportion),shape=21, fill="grey", size=6)+
  labs(x = "Pollinator richness",y="Fruit proportion")+
  facet_wrap(~Year, nrow = 1) + 
  theme_bw ()+
  theme(legend.position = "none")



# model 2
mod2_to= glmer(cbind(fruit_formado, Fruit_No) ~ visitatio_rate * Year + (1|Site_ID/Plant_gen_sp),family=binomial,data=Pollinator_Plant)

#getting effects for the two variables
ee_mod2 <- as.data.frame(Effect(c("visitatio_rate","Year"),mod = mod2_to))

p2=ggplot(ee_mod2, aes(visitatio_rate,fit))+
  geom_line(size=0.8)+  
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .2)+
  geom_point(data= Pollinator_Plant, aes(x =visitatio_rate , y = fruit_proportion),shape=21, fill="grey", size=6)+
  labs(x = "Visitation rate",y="Fruit proportion")+
  facet_wrap(~Year, nrow = 1) + 
  coord_cartesian(xlim=c(0, quantile(Pollinator_Plant$visitatio_rate,0.95)))+
  theme_bw ()+
  theme(legend.position = "none")


p1/p2&theme(text = element_text(size=35))


```


# Discussion

The results obtained indicate that the stability of visitation rate will increase with higher asynchrony of pollinators and that greater species richness might increase stability of visitation rate indirectly, via enhanced species asynchrony. Contrary to expectations, we found no relationship between the stability of visitor rate and the stability of plant reproductive success. However, we observed that the effect of visitation rate and richness on the fruit propotions is different depending on the year.


\newpage

# Supplementary material


```{r, echo=FALSE, warning=FALSE,message=FALSE,fig.height = 13,fig.width=30,out.width="100%", fig.align='center',fig.cap=" 1. Changes in the stability of visitation rate with the asynchrony (top row) and richness (botton row) are shown for each plant species"}
# model plot (cv_1_visitation~S_total+asynchrony)


# plot for richness
plot_stabi_plant <- data_plant %>%
  nest_by(Plant_gen_sp) %>%
  mutate(mod = list(lm(cv_1_visitation~S_total,data))) %>%
  mutate(mod1 = list(ggeffects::ggpredict(mod, terms = "S_total"))) %>%
  mutate(plots = list(ggplot(mod1, aes(x, predicted)) + geom_line(size=1) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), linetype = 3, alpha=0.2, colour = "black")))

#Cistus crispus
p1=plot_stabi_plant$plots[[1]] + geom_point(data =data_plant %>% filter(Plant_gen_sp == "Cistus crispus"), 
  aes(x =  S_total, y = cv_1_visitation),color="#e41a1c", alpha=0.7,size=7)+ 
  labs(x = "",y="Stability of visitation rate")+scale_x_continuous(limits = c(9, 16))+
  scale_y_continuous(limits = c(-5,9.5))+
  theme_bw ()


#Cistus ladanifer
p2=plot_stabi_plant$plots[[2]] + geom_point(data = data_plant %>% filter(Plant_gen_sp == "Cistus ladanifer"), 
  aes(x =  S_total, y = cv_1_visitation),color="#377eb8",alpha=0.7, size=7)+ 
  labs(x = "",y=NULL)+scale_x_continuous(limits = c(3, 16))+ 
  scale_y_continuous(limits = c(-1.55,4))+
  theme_bw()

#Cistus salviifolius
p3=plot_stabi_plant$plots[[3]] + geom_point(data = data_plant %>% filter(Plant_gen_sp == "Cistus salviifolius"), 
  aes(x =  S_total, y = cv_1_visitation),color= "#4daf4a",alpha=0.7, size=7)+ 
  labs(x = "Richness",y=NULL)+scale_x_continuous(limits = c(3, 20))+  
  scale_y_continuous(limits = c(-3,6))+
  theme_bw()


#Halimium halimifolium
p4=plot_stabi_plant$plots[[4]] + geom_point(data = data_plant %>% filter(Plant_gen_sp == "Halimium halimifolium"), 
  aes(x =  S_total, y = cv_1_visitation), color= "#984ea3",alpha=0.7, size=7)+   labs(x = "",y=NULL)+ scale_x_continuous(limits = c(4, 14))+ 
  scale_y_continuous(limits = c(-0.7,3))+
  theme_bw()


#Lavandula pedunculata
p5=plot_stabi_plant$plots[[5]] + geom_point(data = data_plant %>% filter(Plant_gen_sp == "Lavandula pedunculata"), 
  aes(x =  S_total, y = cv_1_visitation),color="#ff7f00",alpha=0.7, size=7)+ 
  labs(x = "",y=NULL)+  
  scale_y_continuous(limits = c(-0.7,4.7))+
  theme_bw()




# model plot for asynchrony
plot_stabi_plant_2 <- data_plant %>%
  nest_by(Plant_gen_sp) %>%
  mutate(mod = list(lm(cv_1_visitation~asyn_LM,data))) %>%
  mutate(mod1 = list(ggeffects::ggpredict(mod, terms = "asyn_LM"))) %>%
  mutate(plots = list(ggplot(mod1, aes(x, predicted)) + geom_line(size=1) +
 geom_ribbon(aes(ymin = conf.low, ymax = conf.high),linetype = 3, alpha=0.2, colour = "black")))


#Cistus crispus
p1.1=plot_stabi_plant_2$plots[[1]] + geom_point(data = data_plant %>% filter(Plant_gen_sp == "Cistus crispus"), 
  aes(x =  asyn_LM, y = cv_1_visitation),color="#e41a1c",alpha=0.7, size=7)+ 
  labs(x = "",y="Stability of visitaion rate",subtitle = "Cistus crispus")+
  scale_y_continuous(limits = c(-5,9.5))+
   theme_bw()+theme( plot.subtitle = element_text(face = "italic"))


#Cistus ladanifer
p2.1=plot_stabi_plant_2$plots[[2]] + geom_point(data = data_plant %>% filter(Plant_gen_sp == "Cistus ladanifer"), 
  aes(x =  asyn_LM, y = cv_1_visitation),color="#377eb8", alpha=0.7,size=7)+ 
  labs(x = "",y=NULL,subtitle = "Cistus ladanifer")+ 
  scale_y_continuous(limits = c(-1.55,4))+
  theme_bw()+theme( plot.subtitle = element_text(face = "italic"))


#Cistus salviifolius
p3.1=plot_stabi_plant_2$plots[[3]] + geom_point(data = data_plant %>% filter(Plant_gen_sp == "Cistus salviifolius"), 
  aes(x =  asyn_LM, y = cv_1_visitation),color= "#4daf4a",alpha=0.7, size=7)+ 
  labs(x = "Asynchrony of pollinators",y= NULL,subtitle = "Cistus salviifolius")+ 
  scale_y_continuous(limits = c(-3,6))+
  theme_bw()+theme( plot.subtitle = element_text(face = "italic"))


#Halimium halimifolium
p4.1=plot_stabi_plant_2$plots[[4]] + geom_point(data = data_plant %>% filter(Plant_gen_sp == "Halimium halimifolium"), 
  aes(x =  asyn_LM, y = cv_1_visitation), color= "#984ea3", alpha=0.7,size=7)+   labs(x = "",y=NULL,subtitle = "Halimium halimifolium")+ 
  scale_y_continuous(limits = c(-0.7,3))+
  theme_bw() +theme( plot.subtitle = element_text(face = "italic"))


#Lavandula pedunculata
p5.1=plot_stabi_plant_2$plots[[5]] + geom_point(data = data_plant %>% filter(Plant_gen_sp == "Lavandula pedunculata"), 
  aes(x =  asyn_LM, y = cv_1_visitation), color="#ff7f00",alpha=0.7, size=7)+ 
  labs(x = "",y=NULL,subtitle = "Lavandula pedunculata")+  
  scale_y_continuous(limits = c(-0.7,4.7))+
  theme_bw() +theme( plot.subtitle = element_text(face = "italic"))



#join plot
p1.1+p2.1+p3.1+p4.1+p5.1+p1+p2+p3+p4+p5+plot_layout(ncol = 5)& theme(axis.title = element_text(face="bold"))&theme(text = element_text(size=30))


```



```{r,echo=FALSE, warning=FALSE,message=FALSE,fig.height = 13,fig.width=30,out.width="100%", fig.align='center',fig.cap=" 2. Interaction effect between richness and year (top row), and visitation rate and year (bottom row) on seed number. For the visualization purpose, we omit in the visitation rate (x-axis) the values outside of the 95\\%."}

# #scale seed number variable
Pollinator_Plant=Pollinator_Plant %>% 
  group_by(Plant_gen_sp) %>%
  mutate(seed_sc=scale(Seeds, center = T, scale = T))

#model3
mod3_to= lmer(seed_sc ~S_total * Year + (1|Site_ID/Plant_gen_sp),data=Pollinator_Plant)

#getting effects for the two variables
ee_mod3 <- as.data.frame(Effect(c("S_total","Year"),mod = mod3_to))

p3=ggplot(ee_mod3, aes(S_total,fit))+
  geom_line(size=0.8)+ 
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .2)+
  geom_point(data= Pollinator_Plant, aes(x = S_total , y = seed_sc),shape=21, fill="grey", size=6)+
  labs(x = "Pollinator richness",y="Seed number")+
  ylim(-3,3)+
  facet_wrap(~Year, nrow = 1) + 
  theme_bw ()+
  theme(legend.position = "none")

#model4
mod4_to= lmer(seed_sc ~ visitatio_rate*Year + (1|Site_ID/Plant_gen_sp),data=Pollinator_Plant)


#getting effects for the two variables
ee_mod4 <- as.data.frame(Effect(c("visitatio_rate","Year"),mod = mod4_to))

#plot

p4 = ggplot(ee_mod4, aes(visitatio_rate,fit))+
  geom_line(size=0.8)+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .2)+
  geom_point(data= Pollinator_Plant, aes(x =visitatio_rate , y = seed_sc),shape=21, fill="grey",size=6)+
  labs(x = "Visitation rate",y="Seed number")+
  facet_wrap(~Year, nrow = 1) + 
  coord_cartesian(xlim=c(0, quantile(Pollinator_Plant$visitatio_rate,0.95)),ylim = c(-3,3))+
  theme_bw ()+
  theme(legend.position="none")

p3/p4 &theme(text = element_text(size=35))

```





# References
